// –Ø–Ω–¥–µ–∫—Å GPT –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
const YANDEX_API_KEY = process.env.REACT_APP_YANDEX_API_KEY;
const YANDEX_FOLDER_ID = process.env.REACT_APP_YANDEX_FOLDER_ID;
const YANDEX_API_URL = 'https://llm.api.cloud.yandex.net/foundationModels/v1/completion';

console.log('üîë API Key:', YANDEX_API_KEY ? '–ï–°–¢–¨' : '–ù–ï–¢');
console.log('üìÅ Folder ID:', YANDEX_FOLDER_ID ? '–ï–°–¢–¨' : '–ù–ï–¢');

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –Ø–Ω–¥–µ–∫—Å GPT
const isYandexGPTAvailable = () => {
	const available = !!(YANDEX_API_KEY && YANDEX_FOLDER_ID);
	console.log('üîç –Ø–Ω–¥–µ–∫—Å GPT:', available ? '–î–û–°–¢–£–ü–ï–ù' : '–ù–ï –ù–ê–°–¢–†–û–ï–ù');
	console.log('üîë API Key –ø—Ä–æ–≤–µ—Ä–∫–∞:', YANDEX_API_KEY ? `${YANDEX_API_KEY.substring(0, 10)}...` : 'undefined');
	console.log('üìÅ Folder ID –ø—Ä–æ–≤–µ—Ä–∫–∞:', YANDEX_FOLDER_ID ? `${YANDEX_FOLDER_ID.substring(0, 10)}...` : 'undefined');
	return available;
};

// –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –£—Ä–§–£
const createSystemPrompt = () => {
	return `–¢—ã - —Ü–∏—Ñ—Ä–æ–≤–æ–π —Ç—å—é—Ç–æ—Ä –£—Ä–∞–ª—å—Å–∫–æ–≥–æ —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω–æ–≥–æ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞ (–£—Ä–§–£), —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ –ø–æ–º–æ—â–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞–º –ò–†–ò–¢-–†–¢–§.

–ë–ê–ó–ê –ó–ù–ê–ù–ò–ô –£—Ä–§–£:

üèõÔ∏è –†–£–ö–û–í–û–î–°–¢–í–û:
‚Ä¢ –†–µ–∫—Ç–æ—Ä –£—Ä–§–£: –í–∏–∫—Ç–æ—Ä –ê–Ω–∞—Ç–æ–ª—å–µ–≤–∏—á –ö–æ–∫—à–∞—Ä–æ–≤
‚Ä¢ –î–∏—Ä–µ–∫—Ç–æ—Ä –ò–†–ò–¢-–†–¢–§: –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –°–µ—Ä–≥–µ–µ–≤–∏—á –í–æ—Å—Ç—Ä–∏–∫–æ–≤

üë®‚Äçüè´ –ò–ó–í–ï–°–¢–ù–´–ï –ü–†–ï–ü–û–î–ê–í–ê–¢–ï–õ–ò:
‚Ä¢ –í–ª–∞–¥–∏–º–∏—Ä –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏–Ω–æ–≤–∏—á –û–±–∞–±–∫–æ–≤ - –∑–∞–≤–µ–¥—É—é—â–∏–π –∫–∞—Ñ–µ–¥—Ä–æ–π –ê–£–¢–°, –ø—Ä–æ—Ñ–µ—Å—Å–æ—Ä, –¥–æ–∫—Ç–æ—Ä —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –Ω–∞—É–∫. –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å, –∏–∑–≤–µ—Å—Ç–µ–Ω —Å—Ç—Ä–æ–≥–∏–º–∏ —ç–∫–∑–∞–º–µ–Ω–∞–º–∏ –ø–æ —Ç–µ–æ—Ä–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è. –ö–∞–±–∏–Ω–µ—Ç: –†-430.

üè¢ –ö–ê–§–ï–î–†–´ –ò–†–ò–¢-–†–¢–§:
‚Ä¢ –ê–£–¢–° - –ê–≤—Ç–æ–º–∞—Ç–∏–∫–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Å–∏—Å—Ç–µ–º–∞—Ö (–∑–∞–≤. –í.–ö. –û–±–∞–±–∫–æ–≤)
‚Ä¢ –ò–í–¢ - –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞ –∏ –≤—ã—á–∏—Å–ª–∏—Ç–µ–ª—å–Ω–∞—è —Ç–µ—Ö–Ω–∏–∫–∞  
‚Ä¢ –°–ê–ü–† - –°–∏—Å—Ç–µ–º—ã –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
‚Ä¢ –†–∞–¥–∏–æ—Ç–µ—Ö–Ω–∏–∫–∞ –∏ —Å–≤—è–∑—å

üìö –£–ß–ï–ë–ù–´–ô –ü–†–û–¶–ï–°–°:
‚Ä¢ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ: –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç —Å—Ç—É–¥–µ–Ω—Ç–∞ (lk.urfu.ru), —Å–∞–π—Ç –£—Ä–§–£, –º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –£—Ä–§–£
‚Ä¢ –°–µ—Å—Å–∏—è: –∑–∏–º–Ω—è—è (—è–Ω–≤–∞—Ä—å), –ª–µ—Ç–Ω—è—è (–∏—é–Ω—å)
‚Ä¢ –≠–∫–∑–∞–º–µ–Ω—ã: —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è –∑–∞ 2 –Ω–µ–¥–µ–ª–∏ –¥–æ –Ω–∞—á–∞–ª–∞ —Å–µ—Å—Å–∏–∏
‚Ä¢ –ü–µ—Ä–µ—Å–¥–∞—á–∏: –¥–æ 3 –ø–æ–ø—ã—Ç–æ–∫, –Ω—É–∂–Ω–æ –∑–∞—è–≤–ª–µ–Ω–∏–µ –≤ –¥–µ–∫–∞–Ω–∞—Ç

üìû –í–ê–ñ–ù–´–ï –ö–û–ù–¢–ê–ö–¢–´:
‚Ä¢ –î–µ–∫–∞–Ω–∞—Ç –ò–†–ò–¢-–†–¢–§: —É–ª. –ú–∏—Ä–∞ 19, –∫–∞–±. 123, +7 (343) 375-40-00
‚Ä¢ –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –£—Ä–§–£: —É–ª. –¢—É—Ä–≥–µ–Ω–µ–≤–∞ 4, –ü–Ω-–°–± 9:00-21:00
‚Ä¢ –û–±—â–µ–∂–∏—Ç–∏—è: —É–ª. 8 –ú–∞—Ä—Ç–∞ 62, +7 (343) 375-40-00
‚Ä¢ –¢–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞: –∫—Ä—É–≥–ª–æ—Å—É—Ç–æ—á–Ω–æ +7 (343) 375-40-00
‚Ä¢ –°—Ç—É–¥–µ–Ω—á–µ—Å–∫–∞—è –ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞: —É–ª. –ö–æ–º—Å–æ–º–æ–ª—å—Å–∫–∞—è 59–±

üéì –°–¢–£–î–ï–ù–ß–ï–°–ö–ê–Ø –ñ–ò–ó–ù–¨:
‚Ä¢ –°–æ—é–∑ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –£—Ä–§–£: https://posurfu.ru/
‚Ä¢ –°—Ç—É–¥–µ–Ω—á–µ—Å–∫–æ–µ IT-–æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –Æ–ù–ò–¢
‚Ä¢ –°–ø–æ—Ä—Ç–∏–≤–Ω—ã–µ —Å–µ–∫—Ü–∏–∏ –∏ –∫—Ä—É–∂–∫–∏
‚Ä¢ –ö—É–ª—å—Ç—É—Ä–Ω—ã–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è

–°–¢–ò–õ–¨ –û–¢–í–ï–¢–ê:
- –û—Ç–≤–µ—á–∞–π –¥—Ä—É–∂–µ–ª—é–±–Ω–æ –∏ –ø–æ–Ω—è—Ç–Ω–æ üòä
- –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –¥–ª—è –æ–∂–∏–≤–ª–µ–Ω–∏—è
- –î–∞–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π
- –ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å —Ç–æ—á–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ - –Ω–∞–ø—Ä–∞–≤–ª—è–π –≤ –¥–µ–∫–∞–Ω–∞—Ç
- –û—Ç–≤–µ—Ç—ã –¥–æ 250 —Å–ª–æ–≤
- –¢–æ–ª—å–∫–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
- –ë—É–¥—å –ø–æ–ª–µ–∑–Ω—ã–º –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–º

–ü–æ–º–æ–≥–∞–π —Å—Ç—É–¥–µ–Ω—Ç–∞–º —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ –æ–± —É—á–µ–±–µ, —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏, –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è—Ö, –∫–æ–Ω—Ç–∞–∫—Ç–∞—Ö –∏ —Å—Ç—É–¥–µ–Ω—á–µ—Å–∫–æ–π –∂–∏–∑–Ω–∏ –£—Ä–§–£.`;
};

// –ó–∞–ø—Ä–æ—Å –∫ –Ø–Ω–¥–µ–∫—Å GPT
const getYandexGPTResponse = async (userMessage, conversationHistory = []) => {
	try {
		console.log('üöÄ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ –Ø–Ω–¥–µ–∫—Å GPT...');
		console.log('üîó URL:', YANDEX_API_URL);

		// –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
		const messages = [
			{
				role: 'system',
				text: createSystemPrompt()
			}
		];

		// –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 6 —Å–æ–æ–±—â–µ–Ω–∏–π)
		if (conversationHistory.length > 0) {
			conversationHistory.slice(-6).forEach(msg => {
				messages.push({
					role: msg.role === 'user' ? 'user' : 'assistant',
					text: msg.content
				});
			});
		}

		// –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
		messages.push({
			role: 'user',
			text: userMessage
		});

		const requestBody = {
			modelUri: `gpt://${YANDEX_FOLDER_ID}/yandexgpt-lite`,
			completionOptions: {
				stream: false,
				temperature: 0.7,
				maxTokens: 800
			},
			messages: messages
		};

		console.log('üì¶ Request body:', JSON.stringify(requestBody, null, 2));

		const response = await fetch(YANDEX_API_URL, {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
				'Authorization': `Api-Key ${YANDEX_API_KEY}`,
				'x-folder-id': YANDEX_FOLDER_ID
			},
			body: JSON.stringify(requestBody)
		});

		console.log('üì° Response status:', response.status);
		console.log('üì° Response headers:', Object.fromEntries(response.headers.entries()));

		if (!response.ok) {
			const errorText = await response.text();
			console.error('‚ùå –û—à–∏–±–∫–∞ –Ø–Ω–¥–µ–∫—Å GPT:', response.status, errorText);
			throw new Error(`HTTP ${response.status}: ${errorText}`);
		}

		const data = await response.json();
		console.log('üì• Response data:', data);

		const aiResponse = data.result.alternatives[0].message.text;

		console.log('‚úÖ –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç –Ø–Ω–¥–µ–∫—Å GPT');
		return aiResponse;

	} catch (error) {
		console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ –Ø–Ω–¥–µ–∫—Å GPT:', error);
		throw error;
	}
};

// –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞
export const getAIResponse = async (userMessage, conversationHistory = []) => {
	console.log('üì§ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ:', userMessage);

	if (isYandexGPTAvailable()) {
		try {
			const response = await getYandexGPTResponse(userMessage, conversationHistory);
			return response;
		} catch (error) {
			console.error('‚ùå –û—à–∏–±–∫–∞ –Ø–Ω–¥–µ–∫—Å GPT:', error.message);
			throw new Error(`–Ø–Ω–¥–µ–∫—Å GPT –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: ${error.message}`);
		}
	} else {
		throw new Error('–Ø–Ω–¥–µ–∫—Å GPT –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è.');
	}
};

